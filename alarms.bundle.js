/***********************
 * CUSTOM ALARM RULES GENERATED BY ALARMS BUILDER
 * Generated on: 18/10/2025, 17:42:17
 * Total rules: 100
 ***********************/

// Color legend:
// - warning    = ðŸŸ¨ alerta / riesgo intermedio
// - critical   = ðŸ”´ alarma mayor / falla inminente  
// - improving  = ðŸŸ© mejorÃ­a clÃ­nica/metabÃ³lica
// - wean_ok    = ðŸ”µ criterios cumplidos para destete

window.ALARM_RULES = [
// Congestion
{ subtitle: "Congestion", items: [
  { expr: "PCWP > 25", color: "critical", tag: "severe_pulmonary_congestion", label: "Severe Pulmonary Congestion", id: "severe_pulmonary_congestion", clinical: "Markedly elevated left-sided filling pressure with high risk of pulmonary edema.", suggest: "Aggressively unload the LV (diuretics/axial-flow) and consider ventilatory support." },
  { expr: "PCWP > 18 && PCWP <= 25", color: "warning", tag: "moderate_pulmonary_congestion", label: "Moderate Pulmonary Congestion", id: "moderate_pulmonary_congestion", clinical: "Moderately elevated wedge pressure.", suggest: "Intensify diuretic therapy and monitor closely." },
  { expr: "PCWP > 15 && PCWP <= 18", color: "warning", tag: "mild_pulmonary_congestion", label: "Mild Pulmonary Congestion", id: "mild_pulmonary_congestion", clinical: "Early elevation in left-sided filling pressure.", suggest: "Consider diuresis and frequent reassessment of volume status." },
  { expr: "RAP > 15", color: "critical", tag: "severe_systemic_congestion", label: "Severe Systemic Congestion", id: "severe_systemic_congestion", clinical: "Marked systemic venous congestion with risk of organ dysfunction.", suggest: "Aggressive decongestion and evaluate right ventricular function." },
  { expr: "RAP > 12 && RAP <= 15", color: "warning", tag: "moderate_systemic_congestion", label: "Moderate Systemic Congestion", id: "moderate_systemic_congestion", clinical: "Moderately elevated right atrial pressure.", suggest: "Optimize diuretics and RV afterload." },
  { expr: "PCWP > 18 && RAP > 12", color: "critical", tag: "biventricular_congestion", label: "Biventricular Congestion", id: "biventricular_congestion", clinical: "Simultaneous right and left filling pressure elevation indicating biventricular failure.", suggest: "Consider mechanical support plus aggressive decongestion." },
  { expr: "PCWP > 18 && RAP < 12", color: "critical", tag: "left_sided_congestion", label: "Left-Sided Congestion", id: "left_sided_congestion", clinical: "Isolated LV failure with high wedge and normal RAP.", suggest: "Unload the LV (prefer axial-flow) and diurese." },
  { expr: "PCWP < 18 && RAP > 12", color: "critical", tag: "right_sided_congestion", label: "Right-Sided Congestion", id: "right_sided_congestion", clinical: "Isolated RV failure with high RAP and low wedge.", suggest: "Support the RV and reduce pulmonary afterload." },
  { expr: "PVR_WU > 3", color: "critical", tag: "high_pvr", label: "High PVR", id: "high_pvr", clinical: "Severely increased pulmonary vascular load.", suggest: "Treat hypoxia/acidosis and consider pulmonary vasodilators." },
  { expr: "PVR_WU > 2 && PVR_WU <= 3", color: "warning", tag: "moderate_pvr", label: "Moderate PVR", id: "moderate_pvr", clinical: "Mild-to-moderate elevation in PVR.", suggest: "Monitor trend and correct reversible factors." },
  { expr: "PVRI_WU > 2.5", color: "critical", tag: "high_pvri", label: "High PVRI", id: "high_pvri", clinical: "Indexed pulmonary hypertension.", suggest: "Consider pulmonary vasodilators and evaluate for lung pathology or thrombosis." },
  { expr: "PVRI_WU > 2 && PVRI_WU <= 2.5", color: "warning", tag: "moderate_pvri", label: "Moderate PVRI", id: "moderate_pvri", clinical: "Mildly elevated indexed pulmonary resistance.", suggest: "Optimize oxygenation and ventilation; monitor." },
  { expr: "RAP_PCWP_ratio > 0.8", color: "critical", tag: "high_rap_pcwp_ratio", label: "High RAP/PCWP Ratio", id: "high_rap_pcwp_ratio", clinical: "Disproportionate right-sided pressure implies RV failure.", suggest: "Assess RV function and treat pulmonary hypertension." },
  { expr: "RAP_PCWP_ratio >= 0.6 && RAP_PCWP_ratio <= 0.8", color: "warning", tag: "borderline_rap_pcwp_ratio", label: "Borderline RAP/PCWP Ratio", id: "borderline_rap_pcwp_ratio", clinical: "Balanced but elevated right filling pressures.", suggest: "Monitor and optimize RV afterload." },
  { expr: "RAP_PCWP_ratio < 0.6", color: "improving", tag: "normal_rap_pcwp_ratio", label: "Normal RAP/PCWP Ratio", id: "normal_rap_pcwp_ratio", clinical: "Appropriately lower right-sided pressures.", suggest: "Continue current therapy." },
  { expr: "PCWP > 18 && SvO2 < 60", color: "critical", tag: "congestion_with_low_svo2", label: "Congestion with Low SvO2", id: "congestion_with_low_svo2", clinical: "Congestion plus hypoperfusion.", suggest: "Improve forward flow and unload the ventricle; consider MCS." },
  { expr: "(PCWP >= 18 && RAP <= 15 && Lactate >= 2.5) && EF <= 40", color: "critical", tag: "mafp_candidate", label: "Axial-Flow Candidate", id: "mafp_candidate", clinical: "LV failure pattern suitable for axial-flow unloading.", suggest: "Consider Impella plus diuresis and afterload reduction." },
  { expr: "RAP > 20", color: "critical", tag: "extreme_systemic_congestion", label: "Extreme Systemic Congestion", id: "extreme_systemic_congestion", clinical: "Massive venous congestion with imminent organ failure.", suggest: "Maximize decongestion; consider RV mechanical support." },
  { expr: "PCWP > 20 && PVR_WU > 3", color: "critical", tag: "pulmonary_congestion_high_pvr", label: "Pulmonary Congestion with High PVR", id: "pulmonary_congestion_high_pvr", clinical: "Severe combined left and pulmonary hypertension.", suggest: "LV unloading plus pulmonary vasodilation or ECMO if needed." },
  { expr: "PCWP < 12 && RAP > 12", color: "warning", tag: "systemic_pulmonary_imbalance", label: "Systemic vs Pulmonary Imbalance", id: "systemic_pulmonary_imbalance", clinical: "Low wedge with high RAP suggests isolated right-sided congestion.", suggest: "Focus on RV support and reduce pulmonary pressures." }
]},


// Metabolic
{ subtitle: "Metabolic", items: [
  { expr: "Lactate > 10", color: "critical", tag: "critical_hyperlactatemia", label: "Critical Hyperlactatemia", id: "critical_hyperlactatemia", clinical: "Profound shock with anaerobic metabolism.", suggest: "Initiate emergent resuscitation; consider ECMO for refractory shock." },
  { expr: "Lactate > 5 && Lactate <= 10", color: "critical", tag: "severe_hyperlactatemia", label: "Severe Hyperlactatemia", id: "severe_hyperlactatemia", clinical: "Severe hypoperfusion.", suggest: "Escalate support to improve perfusion and oxygen delivery." },
  { expr: "Lactate > 2 && Lactate <= 5", color: "warning", tag: "moderate_hyperlactatemia", label: "Moderate Hyperlactatemia", id: "moderate_hyperlactatemia", clinical: "Early metabolic derangement.", suggest: "Address perfusion deficits early to prevent progression." },
  { expr: "pH <= 7.20", color: "critical", tag: "severe_acidosis", label: "Severe Acidosis", id: "severe_acidosis", clinical: "High risk of impaired cardiac function due to acidosis.", suggest: "Aggressively treat shock; consider bicarbonate if extreme." },
  { expr: "pH > 7.20 && pH < 7.30", color: "warning", tag: "moderate_acidosis", label: "Moderate Acidosis", id: "moderate_acidosis", clinical: "Moderate metabolic acidosis.", suggest: "Continue resuscitation and correct causes." },
  { expr: "pH > 7.45", color: "warning", tag: "alkalemia", label: "Alkalemia", id: "alkalemia", clinical: "Metabolic alkalosis or compensatory hyperventilation.", suggest: "Investigate cause and adjust therapy accordingly." },
  { expr: "ALT > 500", color: "critical", tag: "shock_liver", label: "Shock Liver", id: "shock_liver", clinical: "Severe hepatic injury from hypoperfusion.", suggest: "Improve perfusion and avoid hepatotoxic drugs." },
  { expr: "ALT > 200 && ALT <= 500", color: "warning", tag: "moderate_alt_elevation", label: "Moderate ALT Elevation", id: "moderate_alt_elevation", clinical: "Moderate hepatic ischemia.", suggest: "Improve hepatic blood flow; trend LFTs." },
  { expr: "Delta(\"Lactate\") > 1", color: "critical", tag: "lactate_rising", label: "Lactate Rising", id: "lactate_rising", clinical: "Lactate increased by >1 mmol/L since prior measurement.", suggest: "Escalate resuscitation; search for ongoing hypoperfusion." },
  { expr: "(Delta(\"Lactate\") >= 0 && Delta(\"Lactate\") <= 1) && Lactate >= 2", color: "warning", tag: "lactate_plateau", label: "Lactate Plateau", id: "lactate_plateau", clinical: "No meaningful decrease in lactate.", suggest: "Reassess hemodynamics and adjust therapy." },
  { expr: "Delta(\"Lactate\") <= -0.5", color: "improving", tag: "lactate_improving", label: "Lactate Improving", id: "lactate_improving", clinical: "Lactate is falling (â‰¥0.5 mmol/L).", suggest: "Continue therapy; confirm sustained improvement." },
  { expr: "Delta(\"creatinine\") > 0.3", color: "warning", tag: "creatinine_rising", label: "Creatinine Rising", id: "creatinine_rising", clinical: "Worsening renal function (>0.3 mg/dL increase).", suggest: "Review nephrotoxins and improve renal perfusion; decongest if needed." },
  { expr: "Delta(\"creatinine\") < -0.3", color: "improving", tag: "creatinine_falling", label: "Creatinine Falling", id: "creatinine_falling", clinical: "Renal function improving (>0.3 mg/dL decrease).", suggest: "Continue therapy and adjust diuretics accordingly." }
]},


// Perfusion
{ subtitle: "Perfusion", items: [
  { expr: "MAP < 50", color: "critical", tag: "extremis_hypotension", label: "Extremis Hypotension", id: "extremis_hypotension", clinical: "Imminent circulatory collapse.", suggest: "Initiate aggressive vasopressor support and prepare for mechanical support." },
  { expr: "MAP < 60", color: "critical", tag: "severe_hypotension", label: "Severe Hypotension", id: "severe_hypotension", clinical: "Advanced shock with inadequate tissue perfusion.", suggest: "Optimize preload, start vasopressors, and evaluate for MCS." },
  { expr: "MAP >= 60 && MAP < 65", color: "warning", tag: "low_mean_pressure", label: "Low Mean Pressure", id: "low_mean_pressure", clinical: "Borderline MAP with risk of progression.", suggest: "Monitor closely; adjust fluids/vasopressors to keep MAP â‰¥65." },
  { expr: "MAP > 85", color: "warning", tag: "high_mean_pressure", label: "High Mean Pressure", id: "high_mean_pressure", clinical: "Possible excessive support/afterload.", suggest: "Reassess vasopressor dose; consider de-escalation if organs perfuse." },
  { expr: "CI < 2.0", color: "critical", tag: "critical_low_cardiac_index", label: "Critical Low Cardiac Index", id: "critical_low_cardiac_index", clinical: "Pump failure with inadequate DO2.", suggest: "Start inotropes and consider MCS; delay weaning." },
  { expr: "CI >= 2.0 && CI < 2.2", color: "warning", tag: "borderline_cardiac_index", label: "Borderline Cardiac Index", id: "borderline_cardiac_index", clinical: "Borderline output; early pump dysfunction.", suggest: "Monitor and optimize inotropes/preload/afterload." },
  { expr: "CI > 3.0", color: "warning", tag: "very_high_cardiac_index", label: "Very High Cardiac Index", id: "very_high_cardiac_index", clinical: "Hyperdynamic or high-output failure.", suggest: "Search for alternate/mixed shock (e.g., sepsis) and treat cause." },
  { expr: "CPO < 0.6", color: "critical", tag: "low_cardiac_power", label: "Low Cardiac Power", id: "low_cardiac_power", clinical: "Severe pump failure associated with high mortality.", suggest: "Urgently consider MCS and/or strong inotropes." },
  { expr: "SvO2 < 50", color: "critical", tag: "critical_venous_desaturation", label: "Critical Venous Desaturation", id: "critical_venous_desaturation", clinical: "Severely reduced oxygen delivery.", suggest: "Increase CO and consider transfusion if anemic; optimize ventilation." },
  { expr: "SvO2 >= 50 && SvO2 < 60", color: "warning", tag: "borderline_svo2", label: "Borderline SvO2", id: "borderline_svo2", clinical: "Moderate imbalance between delivery and consumption.", suggest: "Consider increasing CO or oxygen carrying capacity." },
  { expr: "SvO2 >= 65", color: "improving", tag: "optimal_svo2", label: "Optimal Mixed Venous O2", id: "optimal_svo2", clinical: "Adequate balance of oxygen delivery and consumption.", suggest: "Maintain therapy and monitor trends." },
  { expr: "Shock_index > 1.0", color: "critical", tag: "high_shock_index", label: "High Shock Index", id: "high_shock_index", clinical: "Advanced shock and poor prognosis.", suggest: "Escalate therapy; address tachycardia and hypotension." },
  { expr: "Shock_index >= 0.9 && Shock_index <= 1.0", color: "warning", tag: "borderline_shock_index", label: "Borderline Shock Index", id: "borderline_shock_index", clinical: "Early hemodynamic compromise.", suggest: "Monitor closely and optimize HR/BP." },
  { expr: "PulsePressure < 25", color: "warning", tag: "low_pulse_pressure", label: "Low Pulse Pressure", id: "low_pulse_pressure", clinical: "Low stroke volume and impaired forward flow.", suggest: "Increase stroke volume with inotropes and optimize preload; consider MCS." },
  { expr: "PulsePressure < 15", color: "critical", tag: "very_low_pulse_pressure", label: "Very Low Pulse Pressure", id: "very_low_pulse_pressure", clinical: "Severely diminished stroke volume.", suggest: "Urgently address contractility and consider mechanical support." },
  { expr: "PulsePressure >= 40", color: "improving", tag: "normal_pulse_pressure", label: "Normal Pulse Pressure", id: "normal_pulse_pressure", clinical: "Suggests adequate stroke volume/ventricular function.", suggest: "Maintain current treatment; avoid over-resuscitation." }
]},


// Trends
{ subtitle: "Trends", items: [
  { expr: "Delta(\"HR\") > 15", color: "warning", tag: "rising_heart_rate", label: "Rising Heart Rate", id: "rising_heart_rate", clinical: "Increase >15 bpm since last measurement suggests worsening compensatory tachycardia.", suggest: "Assess volume status and triggers; adjust therapy." },
  { expr: "CPO_pct_change < -20", color: "warning", tag: "cardiac_power_decline", label: "Cardiac Power Decline", id: "cardiac_power_decline", clinical: "CPO decreased by >20%.", suggest: "Investigate cause; consider inotropes or MCS." },
  { expr: "CPO_pct_change > 20", color: "improving", tag: "cardiac_power_increase", label: "Cardiac Power Increase", id: "cardiac_power_increase", clinical: "CPO increased, indicating improved contractility/perfusion.", suggest: "Maintain therapy; consider de-escalation if sustained." },
  { expr: "CI_pct_change < -20", color: "warning", tag: "cardiac_index_decline", label: "Cardiac Index Decline", id: "cardiac_index_decline", clinical: "CI decreased by >20%.", suggest: "Increase inotropic support or add mechanical assistance." },
  { expr: "CI_pct_change > 20", color: "improving", tag: "cardiac_index_increase", label: "Cardiac Index Increase", id: "cardiac_index_increase", clinical: "CI increased by â‰¥20%.", suggest: "Continue management and evaluate weaning readiness." },
  { expr: "Delta(\"SvO2\") >= 5", color: "improving", tag: "svo2_rising", label: "SvO2 Rising", id: "svo2_rising", clinical: "Improving oxygen delivery.", suggest: "Continue current plan and monitor stability." },
  { expr: "Delta(\"SvO2\") <= -5", color: "warning", tag: "svo2_falling", label: "SvO2 Falling", id: "svo2_falling", clinical: "Declining oxygen delivery or rising consumption.", suggest: "Search for cause and escalate support as needed." }
]},


// MCS-specific
{ subtitle: "MCS-specific", items: [
  { expr: "Impella == 1 && Impella_flow_Lmin > 0 && Impella_flow_Lmin <= 0.5", color: "critical", tag: "impella_flow_absent", label: "Impella Flow Absent", id: "impella_flow_absent", clinical: "Near-absent pump flow suggests stoppage/failure.", suggest: "Troubleshoot immediately and prepare alternative support." },
  { expr: "Impella == 1 && CountTrue([CI >= 2.0, SvO2 >= 55, Lactate <= 2.5, pH >= 7.30]) >= 3", color: "improving", tag: "impella_try_wean_test", label: "Impella Try-Wean Criteria Met", id: "impella_try_wean_test", clinical: "Targets met to attempt P-level reduction.", suggest: "Consider stepwise P-level reduction with close monitoring." },
  { expr: "Impella == 1 && Impella_flow_Lmin > 0 && Impella_flow_Lmin <= 1.0 && CountTrue([CI >= 2.0, SvO2 >= 55, Lactate <= 2.5, pH >= 7.30]) >= 3 && MAP >= 65", color: "wean_ok", tag: "impella_ready_for_removal", label: "Impella Ready for Removal", id: "impella_ready_for_removal", clinical: "Criteria met for safe Impella removal.", suggest: "Plan removal in a controlled environment with hemodynamic monitoring." },
  { expr: "Impella == 1 && (CPO < 0.6 || SvO2 < 50)", color: "warning", tag: "impella_removal_not_ready", label: "Impella Removal Not Ready", id: "impella_removal_not_ready", clinical: "Contractility/DO2 insufficient for safe removal.", suggest: "Hold removal; optimize inotropy and oxygen delivery." },
  { expr: "IABP == 1 && (MAP < 65 || CPO <= 0.6)", color: "critical", tag: "iabp_ineffective", label: "IABP Ineffective", id: "iabp_ineffective", clinical: "Targets unmet despite IABP support.", suggest: "Escalate support or troubleshoot timing/volume." },
  { expr: "IABP == 1 && MAP > 70 && CI >= 2 && RAP < 12 && PCWP < 18 && Lactate < 2.5 && pressorsOn == 0", color: "wean_ok", tag: "iabp_weaning_ready", label: "IABP Weaning Ready", id: "iabp_weaning_ready", clinical: "All criteria for safe IABP weaning are met.", suggest: "Reduce balloon inflation ratio stepwise." },
  { expr: "ECMO == 1 && CPO >= 0.6 && CI > 2.4 && PCWP <= 18 && MAP > 65 && SvO2 >= 65 && Lactate < 2", color: "wean_ok", tag: "ecmo_weaning_ready", label: "ECMO Weaning Ready", id: "ecmo_weaning_ready", clinical: "Hemodynamic criteria for VA-ECMO weaning are satisfied.", suggest: "Proceed with stepwise flow reduction; monitor response." },
  { expr: "ECMO == 1 && ECMO_flow_Lmin <= 1.5 && CI >= 2.2 && MAP >= 60", color: "wean_ok", tag: "ecmo_pump_off_success", label: "ECMO Pump-Off Success", id: "ecmo_pump_off_success", clinical: "Low ECMO flow with stable CI/MAP indicates readiness for decannulation.", suggest: "Complete trial off support and decannulate if tolerated." },
  { expr: "ECMO == 1 && ECMO_flow_Lmin <= 1.5 && (CI < 2.2 || MAP < 60)", color: "critical", tag: "ecmo_pump_off_failure", label: "ECMO Pump-Off Failure", id: "ecmo_pump_off_failure", clinical: "Instability during pump-off test.", suggest: "Resume ECMO flow; reassess LV/RV support and afterload." },
  { expr: "Delta(\"Impella_flow_Lmin\") < -1", color: "warning", tag: "impella_flow_too_rapidly_reduced", label: "Impella Flow Reduced Too Fast", id: "impella_flow_too_rapidly_reduced", clinical: "Flow decreased by >1 L/min since last measurement.", suggest: "Slow reduction rate to â‰¤0.5 L/min per hour." },
  { expr: "Impella == 1 && ECMO == 1 && PAPI > 1.5 && PCWP < 18 && CPO > 0.6", color: "wean_ok", tag: "combined_ecpella_weaning_ready", label: "Combined ECPELLA Weaning Ready", id: "combined_ecpella_weaning_ready", clinical: "Adequate RV function and low filling pressures under combined support.", suggest: "Begin stepwise ECMO flow reduction while maintaining Impella." },
  { expr: "Impella == 1 && ECMO == 1 && (PAPI <= 1.0 || PCWP > 20)", color: "critical", tag: "combined_wean_failure", label: "Combined Wean Failure", id: "combined_wean_failure", clinical: "RV dysfunction or high filling pressures during combined support.", suggest: "Abort weaning; treat RV failure or decongest." },
  { expr: "(PVR_WU > 3) && (Impella == 1 || ECMO == 1)", color: "warning", tag: "high_pvr_prevents_weaning", label: "High PVR Prevents Weaning", id: "high_pvr_prevents_weaning", clinical: "High RV afterload predicts wean failure.", suggest: "Reduce PVR (optimize oxygenation/pH, consider vasodilators) before weaning." },
  { expr: "EF < 25 && (Impella == 1 || ECMO == 1)", color: "warning", tag: "low_ef_prevents_weaning", label: "Low EF Prevents Weaning", id: "low_ef_prevents_weaning", clinical: "Severely depressed LV function precludes safe weaning.", suggest: "Delay weaning; optimize LV recovery/unloading." }
]},


// Weaning
{ subtitle: "Weaning", items: [
  { expr: "inotropesOn == 0 && MAP >= 65 && CI >= 2.5 && CPO >= 0.6", color: "wean_ok", tag: "inotrope_wean_ready", label: "Inotrope Wean Ready", id: "inotrope_wean_ready", clinical: "Adequate hemodynamics without inotropes.", suggest: "Taper remaining vasoactives and monitor stability." },
  { expr: "Delta(\"CI\") < -0.3 && Delta(\"inotropesOn\") < 0", color: "critical", tag: "inotrope_wean_failure", label: "Inotrope Wean Failure", id: "inotrope_wean_failure", clinical: "CI falls significantly during inotrope reduction.", suggest: "Reinstate inotrope and evaluate for pump failure or volume issues." },
  { expr: "Delta(\"Impella\") < 0 && MAP >= 65", color: "wean_ok", tag: "post_wean_stability", label: "Post-Wean Stability", id: "post_wean_stability", clinical: "Device removal followed by stable MAP.", suggest: "Continue monitoring for at least 12 hours." },
  { expr: "MAP >= 65 && CI >= 2.5 && SVR >= 800 && SVR <= 1000 && SvO2 >= 65 && CPO >= 0.6", color: "wean_ok", tag: "hemodynamic_target_met", label: "Hemodynamic Targets Met", id: "hemodynamic_target_met", clinical: "All guideline targets achieved.", suggest: "Plan de-escalation of mechanical and pharmacologic support." },
  { expr: "CPO > 0.6 && PAPI > 1.0 && PCWP < 18 && CI > 2.4 && Lactate < 2.5 && pH > 7.3", color: "wean_ok", tag: "comprehensive_weaning_success", label: "Comprehensive Weaning Success", id: "comprehensive_weaning_success", clinical: "Global hemodynamic and metabolic stability.", suggest: "Proceed with device weaning under supervision." },
  { expr: "(CPO <= 0.6 || PAPI <= 1.0)", color: "critical", tag: "comprehensive_weaning_failure", label: "Comprehensive Weaning Failure", id: "comprehensive_weaning_failure", clinical: "Targets for safe weaning are not met.", suggest: "Abort weaning; treat low power or RV dysfunction." }
]},


// Other
{ subtitle: "Other", items: [
  { expr: "SCAI >= 3", color: "critical", tag: "scai_stage_d_e", label: "SCAI Stage D/E", id: "scai_stage_d_e", clinical: "Advanced or extremis cardiogenic shock with high mortality.", suggest: "Immediate escalation to mechanical support and aggressive resuscitation." },
  { expr: "SCAI == 2", color: "warning", tag: "scai_stage_c", label: "SCAI Stage C", id: "scai_stage_c", clinical: "Classic cardiogenic shock requiring prompt intervention.", suggest: "Provide inotropes and consider mechanical support to prevent deterioration." }
]},
// Custom Stroke Work Rules
{ subtitle: "Custom Stroke Work Rules", items: [
  { expr: "LVSWi < 30", color: "critical", tag: "critical_low_lv_stroke_work", label: "Critical Low LV Stroke Work", id: "critical_low_lv_stroke_work", clinical: "Left ventricular stroke work index <30 gÂ·m/mÂ² indicates severely impaired LV function.", suggest: "Escalate inotropic support or consider mechanical assistance; evaluate for afterload reduction." },
  { expr: "LVSWi >= 30 && LVSWi < 40", color: "warning", tag: "borderline_lv_stroke_work", label: "Borderline LV Stroke Work", id: "borderline_lv_stroke_work", clinical: "LSVWi between 30 and 40 gÂ·m/mÂ² suggests borderline LV function.", suggest: "Monitor closely; adjust inotropic support and preload/afterload as needed." },
  { expr: "LVSWi >= 40", color: "improving", tag: "normal_lv_stroke_work", label: "Normal LV Stroke Work", id: "normal_lv_stroke_work", clinical: "LSVWi â‰¥40 gÂ·m/mÂ² reflects adequate left ventricular stroke work.", suggest: "Maintain current therapy; consider weaning support if other parameters are stable." },
  { expr: "RVSWi < 6", color: "critical", tag: "critical_low_rv_stroke_work", label: "Critical Low RV Stroke Work", id: "critical_low_rv_stroke_work", clinical: "Right ventricular stroke work index <6 gÂ·m/mÂ² indicates severe RV failure.", suggest: "Initiate RV-supportive therapy and reduce pulmonary afterload; consider RV assist device." },
  { expr: "RVSWi >= 6 && RVSWi < 8", color: "warning", tag: "borderline_rv_stroke_work", label: "Borderline RV Stroke Work", id: "borderline_rv_stroke_work", clinical: "RVSWi between 6 and 8 gÂ·m/mÂ² suggests borderline RV function.", suggest: "Optimize preload and afterload and monitor for deterioration." },
  { expr: "RVSWi >= 8", color: "improving", tag: "normal_rv_stroke_work", label: "Normal RV Stroke Work", id: "normal_rv_stroke_work", clinical: "RVSWi â‰¥8 gÂ·m/mÂ² indicates adequate RV stroke work.", suggest: "Continue current management and assess readiness for device weaning." },
  { expr: "Delta(\"RVSWi\") < -1", color: "warning", tag: "rv_stroke_work_decline", label: "RV Stroke Work Decline", id: "rv_stroke_work_decline", clinical: "RVSWi has decreased by more than 1 gÂ·m/mÂ² since the last measurement, suggesting worsening RV performance.", suggest: "Investigate the cause (volume, afterload, myocardial function) and adjust therapy accordingly." },
  { expr: "Delta(\"RVSWi\") > 1", color: "improving", tag: "rv_stroke_work_improving", label: "RV Stroke Work Improving", id: "rv_stroke_work_improving", clinical: "RVSWi has increased by more than 1 gÂ·m/mÂ², indicating improving RV function.", suggest: "Maintain therapy and consider reducing RV-specific support if the trend persists." }
]},

// Custom Pressor & Inotrope Rules
{ subtitle: "Custom Pressor & Inotrope Rules", items: [
  { expr: "pressorsOn >= 2", color: "critical", tag: "multiple_pressors", label: "Multiple Pressors Required", id: "multiple_pressors", clinical: "Requiring two or more vasopressors indicates severe vasodilatory or mixed shock.", suggest: "Reevaluate the cause of hypotension and consider mechanical support or alternative therapies." },
  { expr: "Delta(\"pressorsOn\") > 0", color: "warning", tag: "pressors_increasing", label: "Pressors Increasing", id: "pressors_increasing", clinical: "An increase in the number of pressors suggests worsening hemodynamics.", suggest: "Search for reversible causes (e.g., bleeding, sepsis) and optimize resuscitation." },
  { expr: "Delta(\"pressorsOn\") < 0", color: "improving", tag: "pressors_decreasing", label: "Pressors Decreasing", id: "pressors_decreasing", clinical: "A reduction in the number of pressors indicates improving vasopressor requirement.", suggest: "Continue therapy and consider gradual tapering." },
  { expr: "inotropesOn >= 2", color: "critical", tag: "multiple_inotropes", label: "Multiple Inotropes Required", id: "multiple_inotropes", clinical: "Needing two or more inotropes signals severe pump failure.", suggest: "Evaluate for mechanical circulatory support and adjust therapy to improve contractility." },
  { expr: "Delta(\"inotropesOn\") < 0", color: "improving", tag: "inotropes_decreasing", label: "Inotropes Decreasing", id: "inotropes_decreasing", clinical: "A decrease in the number of inotropes indicates improving myocardial function.", suggest: "Continue careful weaning and reassess cardiac output to prevent recurrence of shock." }
]},

// Custom Afterload Rules
{ subtitle: "Custom Afterload Rules", items: [
  { expr: "SVR > 1200", color: "critical", tag: "very_high_svr", label: "Very High SVR", id: "very_high_svr", clinical: "Systemic vascular resistance above 1200 dynÂ·s/cmâµ indicates excessive afterload, possibly due to high vasopressor dose.", suggest: "Reassess vasopressor dosing; consider vasodilators if end-organ perfusion is adequate." },
  { expr: "SVR >= 1000 && SVR <= 1200", color: "warning", tag: "high_svr", label: "High SVR", id: "high_svr", clinical: "Elevated systemic vascular resistance.", suggest: "Monitor blood pressure, reduce pressor doses as possible, and evaluate afterload reduction." },
  { expr: "SVR >= 800 && SVR < 1000", color: "improving", tag: "normal_svr", label: "Normal SVR", id: "normal_svr", clinical: "Systemic vascular resistance is within acceptable range (800â€“1000 dynÂ·s/cmâµ).", suggest: "Maintain current therapy; ensure adequate organ perfusion." },
  { expr: "SVR < 800 && SVR >= 600", color: "warning", tag: "low_svr", label: "Low SVR", id: "low_svr", clinical: "Lower than normal systemic vascular resistance suggests vasodilatory shock.", suggest: "Increase vasopressors to restore adequate afterload and evaluate for causes such as sepsis." },
  { expr: "SVR < 600", color: "critical", tag: "very_low_svr", label: "Very Low SVR", id: "very_low_svr", clinical: "Critically low systemic vascular resistance compromising organ perfusion.", suggest: "Initiate aggressive vasopressor therapy and investigate underlying causes (e.g., severe sepsis or distributive shock)." }
]},

// Custom RV Function Trending Rules
{ subtitle: "Custom RV Function Trending Rules", items: [
  { expr: "Delta(\"PAPI\") > 0.3", color: "improving", tag: "papi_rising", label: "PAPI Rising", id: "papi_rising", clinical: "Increasing pulmonary artery pulsatility index suggests improving right ventricular function.", suggest: "Continue therapy and consider reducing RV-specific support if the trend persists." },
  { expr: "Delta(\"PAPI\") < -0.3", color: "warning", tag: "papi_falling", label: "PAPI Falling", id: "papi_falling", clinical: "A falling PAPI indicates worsening right ventricular function.", suggest: "Assess preload, afterload, and inotropic support; consider RV assist device if necessary." }
]},

// Custom Cardiac Power Index Rules
{ subtitle: "Custom Cardiac Power Index Rules", items: [
  { expr: "CPI < 0.4", color: "critical", tag: "critical_low_cpi", label: "Critical Low CPI", id: "critical_low_cpi",
    clinical: "Cardiac power index <0.4Â W/mÂ² signals severe pump failure and very low cardiac power.",
    suggest: "Initiate aggressive inotropic support and evaluate for mechanical circulatory support." },
  { expr: "CPI >= 0.4 && CPI < 0.5", color: "warning", tag: "borderline_cpi", label: "Borderline CPI", id: "borderline_cpi",
    clinical: "CPI 0.4â€“0.5Â W/mÂ² is borderline for shock; below the normal range of 0.5â€“0.7Â W/mÂ²",
    suggest: "Optimize preload, afterload and inotrope dosing to prevent decline." },
  { expr: "CPI >= 0.5 && CPI <= 0.7", color: "improving", tag: "normal_cpi", label: "Normal CPI", id: "normal_cpi",
    clinical: "CPI 0.5â€“0.7Â W/mÂ² falls within the normal range associated with better outcomes.",
    suggest: "Maintain current therapy and consider weaning support if sustained." },
  { expr: "CPI > 0.8", color: "warning", tag: "high_cpi", label: "High CPI", id: "high_cpi",
    clinical: "CPI >0.8Â W/mÂ² may reflect a hyperdynamic or highâ€‘output state (e.g., sepsis).",
    suggest: "Investigate underlying causes and adjust therapy accordingly." }
]},


// Custom Aortic Pulsatility Index Rules
{ subtitle: "Custom Aortic Pulsatility Index Rules", items: [
  { expr: "API < 1.5", color: "critical", tag: "critical_low_api", label: "Critical Low API", id: "critical_low_api",
    clinical: "API <1.5 indicates poor pulsatility and is associated with worse outcomes",
    suggest: "Escalate therapy; evaluate for leftâ€‘sided failure and consider mechanical support." },
  { expr: "API >= 1.5 && API < 2.9", color: "warning", tag: "low_api", label: "Low API", id: "low_api",
    clinical: "API 1.5â€“2.9 is borderline; higher API correlates with better outcomes",
    suggest: "Monitor closely and optimize preload/afterload to improve pulsatility." },
  { expr: "API >= 2.9", color: "improving", tag: "normal_api", label: "Normal API", id: "normal_api",
    clinical: "API â‰¥2.9 is associated with freedom from advanced therapies and better survival.",
    suggest: "Maintain current therapy; consider weaning support if other parameters are stable." }
]},


// Custom Coronary Perfusion Pressure Rules
{ subtitle: "Custom CPP Rules", items: [
  { expr: "CPP < 50", color: "critical", tag: "critical_low_cpp", label: "Critical Low CPP", id: "critical_low_cpp",
    clinical: "Coronary perfusion pressure <50Â mmHg indicates severely impaired myocardial oxygen delivery.",
    suggest: "Raise diastolic pressure or reduce LVEDP (e.g., by LV unloading or diuresis) to restore CPP." },
  { expr: "CPP >= 50 && CPP < 60", color: "warning", tag: "low_cpp", label: "Low CPP", id: "low_cpp",
    clinical: "CPP 50â€“60Â mmHg is below normal",
    suggest: "Optimize vasopressor therapy and ensure adequate volume to maintain CPP â‰¥60Â mmHg." },
  { expr: "CPP >= 60 && CPP <= 80", color: "improving", tag: "normal_cpp", label: "Normal CPP", id: "normal_cpp",
    clinical: "CPP 60â€“80Â mmHg is within the normal range.",
    suggest: "Maintain current therapy and monitor other perfusion parameters." },
  { expr: "CPP > 80", color: "warning", tag: "high_cpp", label: "High CPP", id: "high_cpp",
    clinical: "CPP >80Â mmHg may indicate excessive vasopressor use or afterload.",
    suggest: "Reassess vasopressor dosing and avoid overâ€‘resuscitation." }
]},


// Custom Ejection Fraction Rules
{ subtitle: "Custom Ejection Fraction Rules", items: [
  { expr: "EF < 30", color: "critical", tag: "severe_ef_reduction", label: "Severe EF Reduction", id: "severe_ef_reduction",
    clinical: "Ejection fraction below 30Â % is classified as severely abnormal.",
    suggest: "Initiate or intensify inotropic and mechanical support; evaluate for advanced therapies." },
  { expr: "EF >= 30 && EF < 40", color: "warning", tag: "moderate_ef_reduction", label: "Moderate EF Reduction", id: "moderate_ef_reduction",
    clinical: "EF 30â€“40Â % is moderately abnormal.",
    suggest: "Optimize medical therapy and monitor for further decline." },
  { expr: "EF >= 40 && EF < 50", color: "warning", tag: "mild_ef_reduction", label: "Mild EF Reduction", id: "mild_ef_reduction",
    clinical: "EF 40â€“50Â % is mildly reduced.",
    suggest: "Continue guidelineâ€‘directed therapy; reassess periodically." },
  { expr: "EF >= 50", color: "improving", tag: "normal_ef", label: "Normal EF", id: "normal_ef",
    clinical: "EF â‰¥50Â % is considered normal or preserved.",
    suggest: "Maintain therapy and consider weaning support if other indicators permit." },
  { expr: "Delta(\"EF\") < -5", color: "critical", tag: "ef_decline", label: "EF Decline", id: "ef_decline",
    clinical: "A drop in EF by >5Â % since the last measurement indicates worsening myocardial function.",
    suggest: "Investigate causes (ischemia, device malfunction) and increase support." },
  { expr: "Delta(\"EF\") > 5", color: "improving", tag: "ef_improvement", label: "EF Improvement", id: "ef_improvement",
    clinical: "An increase in EF by >5Â % reflects recovery of systolic function.",
    suggest: "Continue therapy and consider reducing inotropes or mechanical support." }
]},


// Custom Utilization Rules
{ subtitle: "Custom Utilization Rules", items: [
  { expr: "devicesOn >= 2", color: "critical", tag: "multiple_devices_on", label: "Multiple Devices On", id: "multiple_devices_on",
    clinical: "Use of two or more mechanical support devices indicates severe and refractory cardiogenic shock.",
    suggest: "Reassess the overall strategy; consider escalation to durable support or transplant evaluation." },
  { expr: "drugsOn >= 2", color: "critical", tag: "multiple_drugs_on", label: "Multiple Drugs On", id: "multiple_drugs_on",
    clinical: "Needing two or more vasoactive drugs suggests refractory shock.",
    suggest: "Search for reversible causes (bleeding, sepsis) and evaluate for mechanical support." },
  { expr: "Delta(\"devicesOn\") > 0", color: "warning", tag: "devices_increasing", label: "Devices Increasing", id: "devices_increasing",
    clinical: "An increase in the number of devices signals escalation of support.",
    suggest: "Review patient trajectory and determine whether escalation is achieving goals." },
  { expr: "Delta(\"devicesOn\") < 0", color: "improving", tag: "devices_decreasing", label: "Devices Decreasing", id: "devices_decreasing", clinical: "A reduction in device count suggests improving hemodynamics.",  suggest: "Continue monitoring to ensure stability after device removal." }
]},

  // ECPELLA Pathway (VA-ECMO + Impella) Rules
{ subtitle: "ECPELLA Pathway", items: [
  // Flat arterial line â‰ˆ pulsatility ~0
  { expr: "ECMO == 1 && PulsePressure < 5",  color: "critical", tag: "flat_line_ecmo", label: "Flat Arterial Line on VA-ECMO", id: "flat_line_ecmo", clinical: "Minimal arterial pulsatility on VA-ECMO suggests absent AV opening and LV distension.",  suggest: "EMERGENT LV unloading with Impella CP/5.5 if no LV thrombus on echo; consider surgical/LV venting." },
  // EMERGENT: PP < 15 or PCWP > 20 while on VA-ECMO
  { expr: "ECMO == 1 && (PCWP > 20 || (PCWP >= 18 && PulsePressure < 15))",
    color: "critical",
    tag: "ecpella_emergent_unload",
    label: "ECPELLA: Emergent LV Unloading",
    id: "ecpella_emergent_unload",
    clinical: "PCWP >20 mmHg and/or pulse pressure <15 mmHg on VA-ECMO indicates severe LV distension.",
    suggest: "Place Impella CP/5.5 pre-emptively or simultaneously with ECMO if no LV thrombus; escalate venting strategies." },

  // URGENT (within 2 h): wedge rising â‰¥18 with low pulsatility
  { expr: "ECMO == 1 && PCWP >= 18 && Delta(\"PCWP\") > 0 && PulsePressure < 15",
    color: "critical",
    tag: "ecpella_urgent_unload",
    label: "ECPELLA: Urgent LV Unloading",
    id: "ecpella_urgent_unload",
    clinical: "Rising wedge (â‰¥18 mmHg) with low pulsatility on VA-ECMO suggests developing LV distension.",
    suggest: "Initiate LV unloading with Impella CP/5.5 within 2 hours if no LV thrombus." },

  // Watch/prepare: wedge rising â‰¥18 with borderline pulsatility (15â€“25)
  { expr: "ECMO == 1 && PCWP >= 18 && Delta(\"PCWP\") > 0 && PulsePressure >= 15 && PulsePressure < 25",
    color: "warning",
    tag: "ecpella_watch",
    label: "ECPELLA: Distension Watch",
    id: "ecpella_watch",
    clinical: "Wedge â‰¥18 mmHg and rising with borderline pulsatility while on VA-ECMO.",
    suggest: "Escalate diuresis/afterload reduction; prepare LV unloading if parameters worsen." },

  // High-risk phenotype per panel (SCAI C/D/E, EF<30%, PP<15)
  { expr: "ECMO == 1 && (SCAI >= 3 || EF < 30 || PulsePressure < 15)",
    color: "warning",
    tag: "ecpella_high_risk_profile",
    label: "High-Risk ECPELLA Profile",
    id: "ecpella_high_risk_profile",
    clinical: "High-risk features for LV distension while on VA-ECMO (SCAI C/D/E, EF <30%, or low pulse pressure).",
    suggest: "Lower threshold to deploy Impella for LV unloading; close echo surveillance. If LV thrombus is seen, DO NOT place Impella." }
]},

];


// Initialize alarm evaluators when rules are loaded
try {
  if (typeof initAlarmEvaluators === 'function') {
    initAlarmEvaluators();
  }
  if (typeof renderAlarmsReference === 'function') {
    renderAlarmsReference();
  }
  if (typeof generateAll === 'function') {
    generateAll();
  }
  // console.log removed: Custom alarm rules loaded successfully
} catch(e) {
  console.error('Error initializing custom alarm rules:', e);
}

// --- Runtime: Optionally 'desagrupar' las reglas para que cada alarma tenga su propio apartado
// Esto crea una copia ligera de window.ALARM_RULES donde cada regla original se convierte en
// { subtitle: <rule.label>, items: [ <rule> ] }
try {
  if (Array.isArray(window.ALARM_RULES)) {
    const desagrupar = [];
    window.ALARM_RULES.forEach(group => {
      if (group && Array.isArray(group.items)) {
        group.items.forEach(rule => {
          // clone minimal rule to avoid mutating original object references
          const r = Object.assign({}, rule);
          // keep a direct pointer back to the original so runtime evaluation state
          // (for example _lastActive) can be propagated reliably without expensive lookups
          try { r._originalRef = rule; } catch(e) { /* best-effort, non-fatal */ }
          desagrupar.push({ subtitle: r.label || r.id || 'Alarm', items: [r] });
        });
      }
    });
    if (desagrupar.length > 0) {
      // keep a backup reference for debugging
      window._ALARM_RULES_ORIGINAL = window.ALARM_RULES;
      window.ALARM_RULES = desagrupar;
      // re-run initialization hooks if present so UI rebinds to new structure
      if (typeof initAlarmEvaluators === 'function') initAlarmEvaluators();
      if (typeof renderAlarmsReference === 'function') renderAlarmsReference();
      if (typeof generateAll === 'function') generateAll();
      // NOTE: Removed automatic console.info to avoid noisy logs in production.
      // Provide a lightweight, silent debug collector that developers/clinicians
      // can invoke manually from the browser console to inspect active alarms
      // and the current signals store. Usage (paste into the browser console):
      //   window.dumpAlarmDebug(); // prints a JSON-like object to the console
      //   or const dbg = window._collectActiveAlarms(); JSON.stringify(dbg)
      // debug helpers removed for production build
    }
  }
} catch(err) {
  console.error('ALARM-ERROR: failed to desagrupar rules at runtime', err);
}
